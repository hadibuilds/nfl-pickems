version: 1
applications:
  - frontend:
      phases:
        preBuild:
          commands:
            - echo "üöÄ [AMPLIFY] Building frontend for deployment..."
            - cd frontend
            - echo "üßº Cleaning previous builds and caches..."
            - rm -rf dist/
            - rm -rf node_modules/.cache/
            - rm -rf .cache/
            - echo "üì¶ Installing Node.js dependencies..."
            - npm ci --omit=dev
        build:
          commands:
            - echo "üîç Checking environment variables..."
            - |
              if [ -z "$VITE_API_URL" ]; then
                echo "‚ö†Ô∏è  Warning: VITE_API_URL not set, using default"
                export VITE_API_URL="https://api.pickems.fun"
              else
                echo "‚úÖ VITE_API_URL: $VITE_API_URL"
              fi
            - echo "üî® Building React application..."
            - npm run build
            - echo "üìã Build verification..."
            - |
              if [ ! -d "dist" ]; then
                echo "‚ùå Build failed: dist directory not found"
                exit 1
              fi
            - |
              if [ ! -f "dist/index.html" ]; then
                echo "‚ùå Build failed: index.html not found"
                exit 1
              fi
        postBuild:
          commands:
            - echo "üìä Build statistics..."
            - ls -la dist/
            - echo "üìÅ Asset files:"
            - ls -la dist/assets/ 2>/dev/null || echo "No assets directory"
            - echo "üîç Verifying API URL in build..."
            - |
              if grep -q "api.pickems.fun" dist/assets/*.js 2>/dev/null; then
                echo "‚úÖ Production API URL found in build"
              else
                echo "‚ö†Ô∏è  Warning: Production API URL not found in JavaScript files"
              fi
            - echo "üì¶ Final build size:"
            - du -sh dist/
            - echo "‚úÖ [AMPLIFY] Frontend build complete!"
            - echo "üìÅ Build output ready in:" && pwd && echo "/dist/"
      artifacts:
        baseDirectory: frontend/dist
        files:
          - '**/*'
      cache:
        paths:
          - frontend/node_modules/**/*
  - appRoot: frontend