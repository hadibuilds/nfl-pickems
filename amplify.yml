version: 1
applications:
  - appRoot: .
    frontend:
      phases:
        preBuild:
          commands:
            - echo "ğŸš€ [AMPLIFY] Building frontend for deployment..."
            - echo "ğŸ§¼ Cleaning previous builds and caches..."
            - rm -rf dist/
            - rm -rf node_modules/.cache/
            - rm -rf .cache/
            - echo "ğŸ“¦ Installing Node.js dependencies..."
            - npm ci
        build:
          commands:
            - echo "ğŸ” Checking environment variables..."
            - |
              if [ -z "$VITE_API_URL" ]; then
                echo "âš ï¸  Warning: VITE_API_URL not set, using default"
                export VITE_API_URL="https://api.pickems.fun"
              else
                echo "âœ… VITE_API_URL: $VITE_API_URL"
              fi
            - echo "ğŸ”¨ Building React application..."
            - npm run build
            - echo "ğŸ“‹ Build verification..."
            - |
              if [ ! -d "dist" ]; then
                echo "âŒ Build failed: dist directory not found"
                exit 1
              fi
            - |
              if [ ! -f "dist/index.html" ]; then
                echo "âŒ Build failed: index.html not found"
                exit 1
              fi
        postBuild:
          commands:
            - echo "ğŸ“Š Build statistics..."
            - ls -la dist/
            - echo "ğŸ“ Asset files:"
            - ls -la dist/assets/ 2>/dev/null || echo "No assets directory"
            - echo "ğŸ” Verifying API URL in build..."
            - |
              if grep -q "api.pickems.fun" dist/assets/*.js 2>/dev/null; then
                echo "âœ… Production API URL found in build"
              else
                echo "âš ï¸  Warning: Production API URL not found in JavaScript files"
              fi
            - echo "ğŸ“¦ Final build size:"
            - du -sh dist/
            - echo "âœ… [AMPLIFY] Frontend build complete!"
            - echo "ğŸ“ Build output ready in:" && pwd && echo "/dist/"
      artifacts:
        baseDirectory: dist
        files:
          - '**/*'
      cache:
        paths:
          - node_modules/**/*
